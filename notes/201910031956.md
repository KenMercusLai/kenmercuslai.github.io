---
date: 2019-10-03
lastmod: Wednesday, February 5, 2020 at 5:16:47 PM
tags: [[[Networking, LoadBalance, Routers, ECMP]]]
---
# Use Routers for Load Balancing

Instead of using load balancer to load balancing a large volume of traffic, routers are much cheaper of doing so.

The traditional solution with load balancers looks like this:
[[201910032017]]


Routers can be used as load balancers by its equal-cost multi-path (ECMP) forwarding for destinations.[^6778225B3F90]
* Name an IP as the service IP. this IP should **not** exist in the network, or this method will create a black hole.
* Redirect all traffic to the routers for load balancing
* On the routers, use policy/static routes to destinate the incoming traffic to servers behind
* The servers can use any IPs as long as they can communicate with the routers

On the servers, use the iptables to change destination IP for incoming packets and source IP for replies:[^C9BF60671888]

incoming

```bash
iptables -t nat -A PREROUTING -d <service IP> -j DNAT --to-destination <server IP:port>
```

outgoing

```bash
iptables -t nat -A POSTROUTING -d <service IP:port> -j SNAT --to-source <server IP>
```

There is one issue: how to hold states of connections (TCP, TLS and etc.)

The routers have different hash combinations to determine which path should be use for equally distribution. Here we can set it to source IP + source port + destination IP + destination port. Then each connection will always be handled by one server.

Connection ID in the HTTP/3.0 (QUIC) is completely ignored by this method[[201910051049]], causing communication errors in the latest protocol (HTTP/3.0)


[^6778225B3F90]: [[The Technical Challenges of Building Cloudflare WARP]]

[^C9BF60671888]: [[NAT with Linux and iptables - Tutorial (Introduction)]]
