---
date: 201911081421
lastmod: Wednesday, February 5, 2020 at 7:15:33 PM
tags: Docker, git, Gitea, CICD, HomeBuild, RaspberryPI, #docker, #git, #cicd, #homebuild, #gitea, #raspberrypi
---
# Git server and CICD Platform at home

With more and more software development projects I've been working for the last several years, I have thought about several things which drive me moving git repositories from one to another.:
* private repository support. Github didn't support private repository for free tier users, I had to put those repositories in bitbucket and gitlab.
* CICD support. Services like Travis provide unlimited builds for public projects but require a lot for private repositories. The charging of the cost is reasonable but purchasing CICD services personally has never been a smart choice since I never write code regularly. Most of the build time would be wasted.
* Security issue. I won't doubt my insufficiency of software skills and security senses in software. I may add a password file or include credentials in somewhere and mistakenly push them into a public repository.
* Political issues. [Github bans countries](https://techcrunch.com/2019/07/29/github-ban-sanctioned-countries/), [Gitlab bans new hires from China and Russia](https://www.theregister.co.uk/2019/11/04/gitlab_chinese_russian_support_staff_ban/)

For all the major reasons above and some trivial issues, I think a github service with a mature CICD platform is the elixir. After googling and comparing different solutions available, I finally choose Gitea and Drone for the following reasons:
* Both are lightweight, some features lacked have never been used by me for personal projects and research
* Both provide docker deployment officially, in which is perfect for rapid spinning up and down, fast migration and clean boundary between service and data.
* Raspberry PI is powerful enough to run both services. It may be a little slow to run a large test on PI, but it's acceptable and can be easily add a new drone agent with more power.


# System requirement & configuration [^37CE635261BD]

1. Gitea will listen port 22 for git over ssh, so the default need to be changed to another.

in `/etc/ssh/sshd_config`, change the port and restart the service and verify the service is running on the changed port.

```bash
/etc/init.d/sshd restart

ssh -p <new port> user@host
```

2. install docker and docker-compose

# Service deployment

1. create `docker-compose.yml` file [^37CE635261BD][^5CAEA4B438C8]

```yaml
version: "2"

services:
  gitea:
    image: gitea/gitea:latest
    container_name: gitea-app
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - ROOT_URL=http://<the server ip or domain name>:3000
      - SSH_DOMAIN=mydomain.com
      - DB_TYPE=postgres
      - DB_HOST=db:5432
      - DB_NAME=gitea
      - DB_USER=gitea
      - DB_PASSWD=gitea
    restart: always
    volumes:
      - ./volumes/gitea_app:/data
    ports:
      - "3000:3000"
      - "22:22"
    networks:
      - appnet

  gitea-db:
    image: postgres:alpine
    container_name: gitea-db
    ports:
      - 5440:5432
    restart: always
    volumes:
      - ./volumes/gitea_db:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=gitea
      - POSTGRES_PASSWORD=gitea
      - POSTGRES_DB=gitea
    networks:
      - appnet

  drone-server:
    image: drone/drone:0.8
    container_name: drone-server
    ports:
      - 80:8000
      - 9000
    volumes:
      - ./volumes/drone:/var/lib/drone/
    restart: always
    depends_on:
      - gitea
    environment:
      - DRONE_OPEN=true
      - DRONE_HOST=http://drone-server:8000
      - DRONE_GITEA=true
      - DRONE_GITEA_URL=http://gitea:3000
      - DRONE_SECRET=secret
      - DRONE_NETWORK=appnet
    networks:
      - appnet

  drone-agent:
    image: drone/agent:0.8
    container_name: drone-agent
    command: agent
    restart: always
    depends_on:
      - drone-server
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DRONE_SERVER=drone-server:9000
      - DRONE_SECRET=secret
    networks:
      - appnet

volumes:
  gitea-app:
  gitea-db:

networks:
  appnet:
    external: true
```

2. create folder for data

in the **same folder** which contains the docker-compose.yml file

```bash
mkdir volumes
```

3. create docker network

```bash
docker network create appnet
```

the whole system has been properly configured and can be simply booted up by

```bash
docker-compose up -d
```

[^37CE635261BD]: [[Self Hosted Git and CICD Platform with Gitea and Drone on Docker]]

[^5CAEA4B438C8]: [[Installation with Docker - Docs]]